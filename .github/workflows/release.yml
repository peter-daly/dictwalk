name: Release

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: write

jobs:
  guard-main:
    name: guard-main
    runs-on: ubuntu-latest
    steps:
      - name: Ensure workflow runs only on main
        run: |
          if [ "${GITHUB_REF}" != "refs/heads/main" ]; then
            echo "Release workflow can only run on main. Current ref: ${GITHUB_REF}"
            exit 1
          fi

  build-wheels:
    name: wheels (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: guard-main
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@v2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Set up QEMU
        if: matrix.os == 'ubuntu-latest'
        uses: docker/setup-qemu-action@v3

      - name: Build wheels
        uses: pypa/cibuildwheel@v3.2.1
        with:
          output-dir: dist
        env:
          CIBW_BUILD: "cp310-* cp311-* cp312-* cp313-* cp314-*"
          CIBW_SKIP: "pp* *-musllinux_*"
          CIBW_ARCHS_LINUX: "x86_64 aarch64"

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-wheels-${{ matrix.os }}
          path: dist/*.whl

  build-sdist:
    name: sdist
    runs-on: ubuntu-latest
    needs: guard-main

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Build sdist
        run: uv build --sdist

      - name: Upload sdist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-sdist
          path: dist/*.tar.gz

  release:
    name: publish
    runs-on: ubuntu-latest
    needs:
      - guard-main
      - build-wheels
      - build-sdist

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Download wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: dist-wheels-*
          path: dist
          merge-multiple: true

      - name: Download sdist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-sdist
          path: dist

      - name: Show distributions
        run: ls -lah dist

      - name: Resolve version
        run: echo "VERSION=$(uv version --short)" >> "$GITHUB_ENV"

      - name: Publish to PyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: |
          test -n "$UV_PUBLISH_TOKEN"
          uv publish --token "$UV_PUBLISH_TOKEN" dist/*

      - name: Tag release
        run: |
          test -n "$VERSION"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "v$VERSION"
          git push origin "v$VERSION"
